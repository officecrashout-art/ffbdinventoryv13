<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Montserrat:wght@600&display=swap" rel="stylesheet">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
    --primary: #1abc9c;
    --bg-dark: #f0f2f5;       /* Premium Light Grey */
    --bg-card: #ffffff;
    --bg-input: #f8f9fa;
    --bg-hover: #eef2f7;
    --text-main: #2c3e50;
    --text-muted: #8395a7;
    --border: #e1e4e8;
    --shadow: 0 4px 20px rgba(0,0,0,0.05); /* Soft Shadow */
  }
  /* --- 2. DARK MODE OVERRIDES --- */
  [data-theme="dark"] {
    --bg-dark: #0f111a;       /* Deep Blue-Black */
    --bg-card: #1e232e;       /* Card BG */
    --bg-input: #2a303c;
    --bg-hover: #2c3545;
    --text-main: #e6edf3;
    --text-muted: #8b949e;
    --border: #363c45;
    --shadow: 0 4px 20px rgba(0,0,0,0.4); /* Stronger Shadow */
  }

  /* --- 3. GLOBAL RESETS --- */
  body, html { margin: 0; padding: 0; height: 100%; font-family: 'Poppins', sans-serif; }
  body, #main-app { background-color: var(--bg-dark) !important; color: var(--text-main) !important; }
  
  /* Universal Component Fixes */
  .card, .panel, .modal-content, .dash-card {
    background-color: var(--bg-card) !important;
    border: 1px solid var(--border) !important;
    color: var(--text-main) !important;
  }
  
  input, select, textarea {
    background-color: var(--bg-input) !important;
    color: var(--text-main) !important;
    border: 1px solid var(--border) !important;
  }

  th { background-color: var(--bg-card) !important; color: var(--text-muted) !important; border-bottom: 2px solid var(--border) !important; }
  td { border-bottom: 1px solid var(--border) !important; color: var(--text-main) !important; }


/* --- 4. SELECT2 DARK MODE FIX (Aggressive) --- */
  [data-theme="dark"] .select2-container--default .select2-selection--single {
    background-color: var(--bg-input) !important; border-color: var(--border) !important; color: var(--text-main) !important;
  }
  [data-theme="dark"] .select2-dropdown { background-color: var(--bg-card) !important; border-color: var(--border) !important; }
  [data-theme="dark"] .select2-results__option { background-color: var(--bg-card) !important; color: var(--text-main) !important; }
  [data-theme="dark"] .select2-search__field { background-color: var(--bg-input) !important; color: var(--text-main) !important; }
  [data-theme="dark"] .select2-selection__rendered { color: var(--text-main) !important; }

 /* --- 5. LAYOUT --- */
  #login-root { position: fixed; inset: 0; z-index: 10000; background: var(--bg-dark); display: flex; }
  #sidebar { width: 260px; background-color: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.02); }
  .brand-section { padding: 30px 20px; text-align: center; border-bottom: 1px solid var(--border); }
  .brand-section h1 { color: var(--primary); margin: 0; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
  .nav-menu { flex: 1; padding: 20px 0; overflow-y: auto; }
  .nav-item { padding: 12px 25px; display: flex; align-items: center; gap: 15px; color: var(--text-muted); text-decoration: none; transition: 0.2s; font-weight: 500; font-size: 0.9rem; }
  .nav-item:hover { background-color: var(--bg-hover); color: var(--primary); }
  .nav-item.active { background-color: rgba(26, 188, 156, 0.1); color: var(--primary); border-right: 4px solid var(--primary); }
  #main-content { flex: 1; display: flex; flex-direction: column; }
  header { height: 65px; background-color: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
  #page-container { flex: 1; padding: 20px; overflow-y: auto; }

    /* 2. ANIMATED LOGIN PORTAL STYLES */
    #login-root { position: fixed; inset: 0; z-index: 10000; background: #f1f5f9; display: flex; }
    .card-full { width: 100%; display: flex; background: white; }
    .character-side { flex: 0 0 40%; background: #1a1a1a; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; color: white; }
    .brand-title { color: var(--primary); font-size: 32px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 40px; }
    
    .face { width: 180px; height: 180px; background: var(--primary); border-radius: 50%; position: relative; transition: 0.3s; }
    .eye-row { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 20px; transition: 0.3s; }
    .eye-white { width: 28px; height: 32px; background: white; border-radius: 50%; position: relative; overflow: hidden; }
    .pupil { width: 14px; height: 14px; background: #1f2937; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: 0.3s; }
    .look-away .pupil { transform: translate(-80%, -40%); }
    .smile { position: absolute; bottom: 35%; left: 50%; transform: translateX(-50%); width: 40px; height: 20px; border-bottom: 3px solid white; border-radius: 0 0 40px 40px; transition: 0.3s; }
    .frown { border-bottom: none; border-top: 3px solid white; border-radius: 40px 40px 0 0; transform: translateX(-50%) translateY(5px); }
    
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    .angry-face { animation: shake 0.4s ease; background: #ef4444 !important; }

    .form-side { flex: 1; padding: 60px 80px; display: flex; align-items: center; justify-content: center; background: white; }
    .login-form { width: 100%; max-width: 400px; }
    .login-form input { width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; background: #f8fafc; }
    .login-form button { width: 100%; padding: 16px; background: #1a1a1a; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .login-form button:hover { background: var(--primary); transform: translateY(-2px); }

    /* 3. MAIN APP STRUCTURE (RESTORED FEATURES) */
    #main-app { display: none; width: 100%; height: 100vh; background-color: var(--bg-dark); }
    #sidebar { width: 260px; background-color: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: var(--shadow); }
    .brand-section { padding: 30px 20px; text-align: center; border-bottom: 1px solid var(--border); }
    .brand-section h1 { font-family: 'Montserrat', sans-serif; font-size: 1.1rem; margin: 0; color: var(--primary); text-transform: uppercase; }
    
    .nav-menu { flex: 1; padding: 20px 0; overflow-y: auto; }
    .nav-item { padding: 12px 25px; display: flex; align-items: center; gap: 15px; color: var(--text-muted); text-decoration: none; transition: 0.2s; font-size: 0.9rem; }
    .nav-item:hover { background-color: var(--bg-hover); color: var(--primary); }
    .nav-item.active { background-color: rgba(26, 188, 156, 0.1); color: var(--primary); border-right: 4px solid var(--primary); font-weight: 600; }

    #main-content { flex: 1; display: flex; flex-direction: column; }
    header { height: 65px; background-color: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-shadow: var(--shadow); }

    .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; }
    .theme-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
    .theme-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(20px); }

    #page-container { flex: 1; padding: 20px; overflow-y: auto; }
    .logout-btn { background: none; border: 1px solid var(--border); color: var(--text-muted); padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-left: 20px; }
    .logout-btn:hover { color: #ef4444; border-color: #ef4444; }

    /* --- SELECT2 DARK MODE FIX (AGGRESSIVE) --- */
  
  /* 1. The Main Selection Box (Closed) */
  [data-theme="dark"] .select2-container--default .select2-selection--single {
    background-color: var(--bg-card) !important; /* Matches card background */
    border-color: var(--border) !important;
    color: var(--text-main) !important;
  }

  /* 2. The Text Inside the Box */
  [data-theme="dark"] .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: var(--text-main) !important;
  }

  /* 3. The Dropdown List Container (Open) */
  [data-theme="dark"] .select2-dropdown {
    background-color: var(--bg-card) !important;
    border-color: var(--border) !important;
    color: var(--text-main) !important;
  }

  /* 4. The Options in the List */
  [data-theme="dark"] .select2-results__option {
    color: var(--text-main) !important;
    background-color: var(--bg-card) !important;
  }

  /* 5. The Search Box Input (CRITICAL - often invisible) */
  [data-theme="dark"] .select2-search__field {
    background-color: var(--bg-dark) !important; /* Slightly darker to stand out */
    color: var(--text-main) !important;
    border: 1px solid var(--border) !important;
  }

  /* 6. Highlighted/Hovered Item */
  [data-theme="dark"] .select2-results__option--highlighted[aria-selected] {
    background-color: var(--primary) !important;
    color: #fff !important;
  }

  /* 7. The Arrow Icon */
  [data-theme="dark"] .select2-container--default .select2-selection--single .select2-selection__arrow b {
    border-color: var(--text-muted) transparent transparent transparent !important;
  }
  </style>
</head>
<body data-theme="light">

  <div id="login-root"></div>

  <div id="main-app">
    <div style="display: flex; height: 100%;">
      <aside id="sidebar">
        <div class="brand-section"><h1>Fashion Fizz BD</h1></div>
        <nav class="nav-menu">
  <a href="<?= getScriptUrl() ?>?page=dashboard" class="nav-item <?= currentPage == 'dashboard' ? 'active' : '' ?>"><i class="fas fa-chart-pie"></i> Dashboard</a>
  <a href="<?= getScriptUrl() ?>?page=inventory" class="nav-item <?= currentPage == 'inventory' ? 'active' : '' ?>"><i class="fas fa-boxes"></i> Inventory</a>
  
  <a href="<?= getScriptUrl() ?>?page=sales" class="nav-item <?= currentPage == 'sales' ? 'active' : '' ?>"><i class="fas fa-shopping-bag"></i> Sales Orders</a>
  
  <a href="<?= getScriptUrl() ?>?page=sales_details" class="nav-item <?= currentPage == 'sales_details' ? 'active' : '' ?>"><i class="fas fa-list-ul"></i> Sales History</a>
  
  <a href="<?= getScriptUrl() ?>?page=purchases" class="nav-item <?= currentPage == 'purchases' ? 'active' : '' ?>"><i class="fas fa-truck-loading"></i> Purchases</a>
  <a href="<?= getScriptUrl() ?>?page=receipts" class="nav-item <?= currentPage == 'receipts' ? 'active' : '' ?>"><i class="fas fa-cash-register"></i> Receipts</a>
  <a href="<?= getScriptUrl() ?>?page=payments" class="nav-item <?= currentPage == 'payments' ? 'active' : '' ?>"><i class="fas fa-wallet"></i> Payments</a>
  <a href="<?= getScriptUrl() ?>?page=customers" class="nav-item <?= currentPage == 'customers' ? 'active' : '' ?>"><i class="fas fa-user-friends"></i> Customers</a>
  <a href="<?= getScriptUrl() ?>?page=suppliers" class="nav-item <?= currentPage == 'suppliers' ? 'active' : '' ?>"><i class="fas fa-store"></i> Suppliers</a>
  <a href="<?= getScriptUrl() ?>?page=reports" class="nav-item <?= currentPage == 'reports' ? 'active' : '' ?>"><i class="fas fa-chart-line"></i> Reports</a>
  <a href="<?= getScriptUrl() ?>?page=returns" class="nav-item <?= currentPage == 'returns' ? 'active' : '' ?>"><i class="fas fa-exchange-alt"></i> Returns</a>
</nav>
      </aside>

      <main id="main-content">
        <header>
          <div style="font-weight: 500; display: flex; align-items: center;">
            <i class="fas fa-user-shield" style="color: var(--primary); margin-right: 10px;"></i>
            Management Panel
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
          </div>
          <div class="theme-switch-wrapper">
            <i class="fas fa-sun" style="color: #f39c12; font-size: 14px;"></i>
            <label class="theme-switch">
              <input type="checkbox" id="theme-cb" onclick="toggleTheme()">
              <span class="slider"></span>
            </label>
            <i class="fas fa-moon" style="color: #f1c40f; font-size: 14px;"></i>
          </div>
        </header>
        <div id="page-container">
          <?!= include(contentTemplate); ?>
        </div>
      </main>
    </div>
  </div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const LoginPortal = () => {
      const [u, setU] = useState('');
      const [p, setP] = useState('');
      const [isShy, setIsShy] = useState(false);
      const [isAngry, setIsAngry] = useState(false);
      const [msg, setMsg] = useState('');

      const handleLogin = (e) => {
        e.preventDefault();
        setMsg('');
        google.script.run.withSuccessHandler(res => {
          if (res.status === 'success') {
            sessionStorage.setItem('ff_session', 'active');
            document.getElementById('login-root').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
          } else {
            setIsAngry(true);
            setMsg(res.message);
            setTimeout(() => setIsAngry(false), 2000);
          }
        }).checkLogin(u, p);
      };

      return (
        <div id="login-portal-wrapper" className="card-full">
          <div className="character-side">
            <div className="brand-title">Fashion Fizz</div>
            <div className={`face ${isAngry ? 'angry-face' : ''}`}>
              <div className={`eye-row ${isShy ? 'look-away' : ''}`}>
                <div className="eye-white"><div className="pupil"></div></div>
                <div className="eye-white"><div className="pupil"></div></div>
              </div>
              <div className={`smile ${isAngry ? 'frown' : ''}`}></div>
            </div>
            <p style={{marginTop:'40px', fontSize:'11px', opacity:0.6, letterSpacing:'2px'}}>DEVELOPED BY TALHA JALAL</p>
          </div>
          <div className="form-side">
            <div className="login-form">
              <h1 style={{fontSize:'32px', marginBottom:'10px'}}>Welcome</h1>
              <p style={{color:'#64748b', marginBottom:'30px'}}>Enter credentials to access the portal</p>
              <form onSubmit={handleLogin}>
                <label style={{display:'block', marginBottom:'8px', fontWeight:600}}>Username</label>
                <input type="text" value={u} onChange={e=>setU(e.target.value)} placeholder="Email or Username" required />
                
                <label style={{display:'block', marginBottom:'8px', fontWeight:600}}>Password</label>
                <input type="password" value={p} onFocus={()=>setIsShy(true)} onBlur={()=>setIsShy(false)} onChange={e=>setP(e.target.value)} placeholder="••••••••" required />
                
                {msg && <p style={{color:'#ef4444', fontSize:'13px', textAlign:'center'}}>{msg}</p>}
                <button type="submit">ACCESS SYSTEM</button>
              </form>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('login-root'));
    root.render(<LoginPortal />);

    // --- SYSTEM UTILS ---
    if (sessionStorage.getItem('ff_session') === 'active') {
      document.getElementById('login-root').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
    }

    window.handleLogout = () => { sessionStorage.removeItem('ff_session'); location.reload(); };
    window.toggleTheme = () => {
      const theme = document.getElementById('theme-cb').checked ? 'dark' : 'light';
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
    };

    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', theme);
      const cb = document.getElementById('theme-cb');
      if(cb) cb.checked = (theme === 'dark');
    })();
    function openSalesDetails() {
  google.script.run.sdShowSalesDetailsUI();
}


  </script>
</body>
</html>